---
import {
  SITE_TAB,
  SITE_DESCRIPTION,
  SITE_FAVICON,
  SITE_LANGUAGE,
  SITE_THEME,
  SITE_PAGES,
  umamiConfig,
} from "@config";
import "../styles/transition.css";
import Header from "@components/Header.astro";
import Sidebar from "@components/Sidebar.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";

import Banner from "@components/Banner.astro";
import GlobalAudio from "@components/widgets/GlobalAudio.astro";
import SakanaWidget from "@components/widgets/SakanaWidget.astro";
import ScrollToTop from "@components/widgets/ScrollToTop.astro";
import GlobalToaster from "@components/GlobalToaster";

const {
  title,
  image,
  headings = [],
  showTOC = false,
  isIndexed = true,
  showSidebar = true,
  showBanner = true,
} = Astro.props;

// 根据当前路径从配置中获取 Banner 内容
const currentPath = Astro.url.pathname.replace("/", "") || "home";
const pageConfig = SITE_PAGES?.[currentPath];
const bannerTitle = pageConfig?.title || title || "";
const bannerSubtitle = pageConfig?.subtitle || "";
---

<!doctype html>
<html
  lang={SITE_LANGUAGE}
  style="background-color: var(--custom-page-bg)"
  data-theme={SITE_THEME.light}
  data-theme-type="light"
>
  <head>
    <Header
      title={title}
      description={SITE_DESCRIPTION}
      favicon={SITE_FAVICON}
      image={image}
    />
    <title>{`${title} - ${SITE_TAB}`}</title>

    <!-- Umami分析（自建）- 使用 requestIdleCallback 延迟加载，不影响页面渲染 -->
    {
      umamiConfig.enable && umamiConfig.websiteId && (
        <script is:inline define:vars={{ umamiBaseUrl: umamiConfig.baseUrl, umamiWebsiteId: umamiConfig.websiteId }}>
          (function() {
            function loadUmamiScript() {
              if (document.querySelector('script[data-website-id]')) return;
              var s = document.createElement('script');
              s.src = umamiBaseUrl + '/script.js';
              s.defer = true;
              s.setAttribute('data-website-id', umamiWebsiteId);
              document.head.appendChild(s);
            }
            if ('requestIdleCallback' in window) {
              requestIdleCallback(loadUmamiScript, { timeout: 3000 });
            } else {
              setTimeout(loadUmamiScript, 2000);
            }
          })();
        </script>
      )
    }
    {
      umamiConfig.enable && (
        <script is:inline>
          (function() {
            function loadUmamiShare() {
              if (document.querySelector('script[src="/js/umami-share.js"]')) return;
              var s = document.createElement('script');
              s.src = '/js/umami-share.js';
              s.defer = true;
              document.head.appendChild(s);
            }
            if ('requestIdleCallback' in window) {
              requestIdleCallback(loadUmamiShare, { timeout: 3000 });
            } else {
              setTimeout(loadUmamiShare, 2000);
            }
          })();
        </script>
      )
    }




    <script is:inline data-light={SITE_THEME.light} data-dark={SITE_THEME.dark} id="theme-init">
      (function() {
        if (window.__THEME_INIT_V2__) return;
        window.__THEME_INIT_V2__ = true;

        var storedBannerMode = localStorage.getItem("banner-mode") || "normal";
        var t = localStorage.getItem("theme");
        
        // 从当前脚本标签获取配置的默认主题
        var script = document.getElementById("theme-init");
        var light = script ? script.getAttribute("data-light") : "light";
        var dark = script ? script.getAttribute("data-dark") : "dark";
        
        if (!t) {
          t = light;
          localStorage.setItem("theme", t);
        }
        
        document.documentElement.setAttribute("data-theme", t);
        document.documentElement.setAttribute("data-banner-mode", storedBannerMode);
        
        var isDark = t === dark || ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee'].includes(t);
        document.documentElement.setAttribute("data-theme-type", isDark ? "dark" : "light");
      })();
    </script>
  </head>

  <!-- 移除上边距，让Banner从顶部开始 -->
  <body
    class="flex flex-col min-h-screen bg-[var(--banner-wave-bg)] overflow-x-hidden w-full"
    {...isIndexed ? { "data-pagefind-body": true } : {}}
  >
    <div id="swup-banner">
      {showBanner && <Banner title={bannerTitle} subtitle={bannerSubtitle} />}
    </div>
    <Navbar />
    <div class={`max-w-blog mx-auto w-full flex-grow page-content-animate ${showBanner ? 'mt-8' : 'mt-24'}`}>
      <div
        id="swup-grid"
        class={`transition-main grid grid-cols-1 ${showSidebar ? "md:grid-cols-5 lg:grid-cols-4" : ""} gap-4 px-4 pb-4 h-full`}
      >
        <main
          class={`col-span-1 ${showSidebar ? "md:col-span-4 lg:col-span-3" : "w-full"} bg-transparent order-1 md:order-2 flex flex-col gap-4`}
        >
          <div class="flex-grow flex flex-col gap-4">
            <slot />
          </div>
          <Footer />
        </main>
        {
          showSidebar && (
            <aside class="col-span-1 bg-transparent order-2 md:order-1 md:top-4 hidden md:block">
              <Sidebar headings={headings} showTOC={showTOC} />
              <slot name="sidebar" />
            </aside>
          )
        }
      </div>
    </div>


    <!-- <MobileTOC headings={headings} showTOC={showTOC} /> -->
    <GlobalAudio />
    <SakanaWidget />
    <ScrollToTop />

    <!-- 其余脚本保持不变 -->
    <GlobalToaster client:only="react" />
    
    <!-- Music Player Cleanup Script - MUST be in BaseLayout to run on every page -->
    <script is:inline>
      (function() {
        if (window.__MUSIC_CLEANUP_INIT__) return;
        window.__MUSIC_CLEANUP_INIT__ = true;
        
        function stopMusicAnimations() {
          const container = document.querySelector('.music-player-widget');
          if (container) {
            console.log('[BaseLayout] Force removing music widget at', new Date().toISOString());
            container.remove();
          }
          // Also stop any lingering animations on the page
          document.querySelectorAll('.animate-spin-slow').forEach(el => {
            el.style.animation = 'none';
            el.style.transition = 'none';
          });
        }

        // Use Swup hooks API directly (globalInstance: true makes window.swup available)
        function bindSwupHooks() {
          if (window.swup && window.swup.hooks) {
            console.log('[BaseLayout] Binding Swup hooks');
            window.swup.hooks.on('visit:start', stopMusicAnimations);
            window.swup.hooks.on('animation:out:start', stopMusicAnimations);
          }
        }

        // Try immediately (if Swup is already initialized)
        bindSwupHooks();
        
        // Also listen for Swup enable event (in case it initializes later)
        document.addEventListener('swup:enable', bindSwupHooks);
        
        // Fallback: Astro events (these ARE standard DOM events)
        document.addEventListener('astro:before-preparation', stopMusicAnimations);
        document.addEventListener('astro:before-swap', stopMusicAnimations);
      })();
    </script>
    <script is:inline>
      (function() {
        if (window.__THEME_SWAP_INIT__) return;
        window.__THEME_SWAP_INIT__ = true;

        function applyTheme() {
          var t = localStorage.getItem("theme");
          var m = localStorage.getItem("banner-mode") || "normal";
          
          if (t) {
            document.documentElement.setAttribute("data-theme", t);
            var isDark = t === 'dark' || ['dark', 'synthwave', 'halloween', 'forest', 'black', 'luxury', 'dracula', 'business', 'night', 'coffee'].includes(t);
            document.documentElement.setAttribute("data-theme-type", isDark ? "dark" : "light");
          }
          
          document.documentElement.setAttribute("data-banner-mode", m);
        }

        // Astro View Transitions 页面切换
        document.addEventListener("astro:page-load", applyTheme);
      })();
    </script>

    <script is:inline>
      (function() {
        if (window.__PAGE_SCRIPTS_INIT__) return;
        window.__PAGE_SCRIPTS_INIT__ = true;
        
        function initPageScripts() {
          document.querySelectorAll(".btn-copy").forEach((button) => {
            // 避免重复绑定
            if (button.hasAttribute('data-copy-init')) return;
            button.setAttribute('data-copy-init', 'true');
            
            button.addEventListener("click", async () => {
              const codeBlock = button.closest(".ryuchan-code");
              const code = codeBlock.querySelector("code").textContent;
              const copyIcon = button.querySelector(".ryuchan-code-toolbar-copy-icon");
              const successIcon = button.querySelector(".ryuchan-code-toolbar-copy-success");
              try {
                await navigator.clipboard.writeText(code);
                copyIcon.classList.add("hidden");
                successIcon.classList.remove("hidden");
                button.classList.add("copy-success");
                window.dispatchEvent(new CustomEvent('app:toast', { 
                  detail: { type: 'success', message: '代码已复制到剪贴板' } 
                }));
                setTimeout(() => {
                  copyIcon.classList.remove("hidden");
                  successIcon.classList.add("hidden");
                  button.classList.remove("copy-success");
                }, 2000);
              } catch (err) {
                console.error("Failed to copy:", err);
              }
            });
          });
        }

        // 初始页面加载
        initPageScripts();
        
        // Astro View Transitions 页面切换后
        document.addEventListener('astro:page-load', initPageScripts);
      })();
    </script>

    <style is:inline>
      .btn-copy {
        position: relative;
        overflow: hidden;
      }
      .copy-success {
        animation: pulse 0.5s ease-in-out;
      }
  .ryuchan-code-toolbar-copy-success svg {
        color: #10b981;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>
  </body>
</html>
