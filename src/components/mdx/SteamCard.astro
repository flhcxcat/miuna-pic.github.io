---
import { Icon } from "astro-icon/components";
import {
  getSteamGameInfo,
  extractSteamAppId,
  isValidSteamAppId,
} from "@utils/steamApi";

export interface SteamCardProps {
  appId?: string;
  url?: string;
}

const { appId: propAppId, url } = Astro.props as SteamCardProps;

// Extract appId from URL if provided
let appId = propAppId;
if (!appId && url) {
  appId = extractSteamAppId(url) || undefined;
}

// Validate appId
let isValid = Boolean(appId && isValidSteamAppId(appId));
let gameData = null;
let fallbackUrl = url || `https://store.steampowered.com/app/${appId || ""}`;

if (isValid && appId) {
  // Fetch game data
  gameData = await getSteamGameInfo(appId);
  if (!gameData || !gameData.success || !gameData.data) {
    console.error(`Failed to fetch Steam game data for app ID: ${appId}`);
    isValid = false;
    fallbackUrl = `https://store.steampowered.com/app/${appId}`;
  }
} else if (appId) {
  console.error(`Invalid Steam app ID: ${appId}`);
}

const game = gameData?.data;
const steamUrl = appId ? `https://store.steampowered.com/app/${appId}` : fallbackUrl;

// Get price display
const priceDisplay = game?.is_free
  ? "免费游玩"
  : game?.price_overview
    ? game.price_overview.final_formatted
    : "价格未知";

const hasDiscount =
  game?.price_overview && game.price_overview.discount_percent > 0;
---



{!isValid || !game ? (
  <div class="not-prose">
    <a
      href={fallbackUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="text-primary hover:underline"
    >
      {appId ? `Steam Game (App ID: ${appId})` : fallbackUrl}
    </a>
  </div>
) : (
  <div
    class="not-prose steam-card card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 ease-in-out hover:-translate-y-1 animate-fade-in-up border border-base-200 overflow-hidden"
  >
    <a
      href={steamUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="block"
      aria-label={`Visit ${game.name} on Steam`}
    >
      <!-- Header Image -->
      <div class="relative w-full h-32 md:h-36 bg-base-300 overflow-hidden">
        <img
          src={game.header_image}
          alt={game.name}
          loading="lazy"
          class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
        />
        <!-- Price Badge -->
        <div class="absolute bottom-2 left-2">
          {
            hasDiscount ? (
              <div class="flex items-center gap-1">
                <div class="badge badge-error badge-sm font-bold">
                  -{game.price_overview!.discount_percent}%
                </div>
                <div class="bg-base-100/90 backdrop-blur-sm px-2 py-1 rounded text-xs">
                  <div class="text-xs text-base-content/60 line-through">
                    {game.price_overview!.initial_formatted}
                  </div>
                  <div class="text-xs font-bold text-success">
                    {game.price_overview!.final_formatted}
                  </div>
                </div>
              </div>
            ) : (
              <div class="bg-base-100/90 backdrop-blur-sm px-2 py-1 rounded">
                <div
                  class:list={[
                    "font-bold text-xs",
                    game.is_free ? "text-success" : "text-base-content",
                  ]}
                >
                  {priceDisplay}
                </div>
              </div>
            )
          }
        </div>
      </div>

      <!-- Card Content -->
      <div class="card-body p-3 md:p-4">
        <!-- Title and Platforms -->
        <div class="flex items-start justify-between gap-2 mb-1">
          <h2 class="card-title text-base md:text-lg flex-1 line-clamp-2">
            {game.name}
          </h2>
          <div class="flex gap-1 flex-shrink-0">
            {
              game.platforms.windows && (
                <Icon
                  name="mdi:windows"
                  class="w-5 h-5 text-base-content/60"
                  aria-label="Available on Windows"
                />
              )
            }
            {
              game.platforms.mac && (
                <Icon
                  name="mdi:apple"
                  class="w-5 h-5 text-base-content/60"
                  aria-label="Available on Mac"
                />
              )
            }
            {
              game.platforms.linux && (
                <Icon
                  name="mdi:linux"
                  class="w-5 h-5 text-base-content/60"
                  aria-label="Available on Linux"
                />
              )
            }
          </div>
        </div>

        <!-- Developer/Publisher -->
        {
          (game.developers || game.publishers) && (
            <div class="text-sm text-base-content/70 mb-2">
              {game.developers && game.developers.length > 0 && (
                <div>
                  <span class="font-medium">开发商: </span>
                  {game.developers.join(", ")}
                </div>
              )}
              {game.publishers && game.publishers.length > 0 && (
                <div>
                  <span class="font-medium">发行商: </span>
                  {game.publishers.join(", ")}
                </div>
              )}
            </div>
          )
        }

        <!-- Description -->
        <p class="text-base-content/80 line-clamp-3 text-sm mb-4">
          {game.short_description}
        </p>

        <!-- Tags/Genres -->
        {
          game.genres && game.genres.length > 0 && (
            <div class="flex flex-wrap gap-1 mb-3">
              {game.genres.slice(0, 5).map((genre) => (
                <span class="badge badge-outline badge-sm">{genre.description}</span>
              ))}
            </div>
          )
        }

        <!-- Release Date and Metacritic -->
        <div class="flex items-center justify-between text-xs text-base-content/60">
          <div>
            {
              game.release_date.coming_soon ? (
                <span class="text-warning font-medium">即将推出</span>
              ) : (
                <span>发行日期: {game.release_date.date}</span>
              )
            }
          </div>
          {
            game.metacritic && (
              <div class="flex items-center gap-1">
                <Icon name="mdi:star" class="w-4 h-4" />
                <span class="font-medium">{game.metacritic.score}</span>
              </div>
            )
          }
        </div>

        <!-- Action Button -->
        <div class="card-actions justify-end mt-4">
          <div
            class="flex items-center gap-1 text-primary hover:text-primary-focus transition-colors"
          >
            <Icon name="mdi:steam" class="w-5 h-5" aria-hidden="true" />
            <span class="text-sm font-medium">在 Steam 上查看</span>
            <Icon
              name="lucide:external-link"
              class="w-3.5 h-3.5"
              aria-hidden="true"
            />
          </div>
        </div>
      </div>
    </a>
  </div>
)}


<style>
  .steam-card {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(var(--color-border), 0.1);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.3s ease-out forwards;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
