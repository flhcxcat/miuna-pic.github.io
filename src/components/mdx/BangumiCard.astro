---
import { Icon } from "astro-icon/components";
import {
  getBangumiSubject,
  extractBangumiId,
  isValidBangumiId,
  getBangumiTypeName,
} from "@utils/bangumiApi";

export interface BangumiCardProps {
  subjectId?: string;
  url?: string;
}

const { subjectId: propSubjectId, url } = Astro.props as BangumiCardProps;

// Extract subjectId from URL if provided
let subjectId = propSubjectId;
if (!subjectId && url) {
  subjectId = extractBangumiId(url) || undefined;
}

// Validate subjectId
let isValid = Boolean(subjectId && isValidBangumiId(subjectId));
let subjectData = null;
let fallbackUrl = url || `https://bgm.tv/subject/${subjectId || ""}`;

if (isValid && subjectId) {
  // Fetch subject data
  subjectData = await getBangumiSubject(subjectId);
  if (!subjectData) {
    console.error(`Failed to fetch Bangumi subject data for ID: ${subjectId}`);
    isValid = false;
    fallbackUrl = `https://bgm.tv/subject/${subjectId}`;
  }
} else if (subjectId) {
  console.error(`Invalid Bangumi subject ID: ${subjectId}`);
}

const subject = subjectData;
const bangumiUrl = subjectId ? `https://bgm.tv/subject/${subjectId}` : fallbackUrl;

// Get display name (prefer Chinese name)
const displayName = subject?.name_cn || subject?.name || "";
const originalName = subject?.name_cn ? subject?.name : "";
---

{!isValid || !subject ? (
  <div class="not-prose">
    <a
      href={fallbackUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="text-primary hover:underline"
    >
      {subjectId ? `Bangumi (ID: ${subjectId})` : fallbackUrl}
    </a>
  </div>
) : (
  <div
    class="not-prose bangumi-card card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 ease-in-out hover:-translate-y-1 animate-fade-in-up border border-base-200 overflow-hidden"
  >
    <a
      href={bangumiUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="block"
      aria-label={`Visit ${displayName} on Bangumi`}
    >
      <!-- Cover Image -->
      <div class="relative w-full h-32 md:h-36 bg-base-300 overflow-hidden">
        <img
          src={subject.images.large}
          alt={displayName}
          loading="lazy"
          class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
        />
        <!-- Rating Badge -->
        {subject.rating && subject.rating.score > 0 && (
          <div class="absolute bottom-2 left-2">
            <div class="bg-base-100/90 backdrop-blur-sm px-2 py-1 rounded flex items-center gap-1">
              <Icon name="mdi:star" class="w-4 h-4 text-warning" />
              <span class="font-bold text-sm">{subject.rating.score.toFixed(1)}</span>
              <span class="text-xs text-base-content/60">({subject.rating.total})</span>
            </div>
          </div>
        )}
        <!-- Type Badge -->
        <div class="absolute top-2 right-2">
          <div class="badge badge-primary badge-sm">
            {getBangumiTypeName(subject.type)}
          </div>
        </div>
      </div>

      <!-- Card Content -->
      <div class="card-body p-3 md:p-4">
        <!-- Title -->
        <div class="mb-1">
          <h2 class="card-title text-base md:text-lg line-clamp-1">
            {displayName}
          </h2>
          {originalName && (
            <p class="text-xs text-base-content/60 line-clamp-1">{originalName}</p>
          )}
        </div>

        <!-- Summary -->
        <p class="text-sm text-base-content/80 line-clamp-2 mb-2">
          {subject.summary || "暂无简介"}
        </p>

        <!-- Tags -->
        {subject.tags && subject.tags.length > 0 && (
          <div class="flex flex-wrap gap-1 mb-2">
            {subject.tags.slice(0, 5).map((tag) => (
              <span class="badge badge-outline badge-sm">{tag.name}</span>
            ))}
          </div>
        )}

        <!-- Meta Info -->
        <div class="flex items-center justify-between text-xs text-base-content/60">
          <div class="flex items-center gap-2">
            {subject.date && (
              <span>{subject.date}</span>
            )}
            {subject.eps_count && (
              <span>• {subject.eps_count}话</span>
            )}
          </div>
        </div>

        <!-- Action Button -->
        <div class="card-actions justify-end mt-2">
          <div
            class="flex items-center gap-1 text-primary hover:text-primary-focus transition-colors text-xs"
          >
            <Icon name="mdi:book-open-variant" class="w-4 h-4" aria-hidden="true" />
            <span class="font-medium">在 Bangumi 上查看</span>
            <Icon
              name="lucide:external-link"
              class="w-3 h-3"
              aria-hidden="true"
            />
          </div>
        </div>
      </div>
    </a>
  </div>
)}

<style>
  .bangumi-card {
    backdrop-filter: blur(10px);
    border: 1px solid rgba(var(--color-border), 0.1);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.3s ease-out forwards;
  }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
